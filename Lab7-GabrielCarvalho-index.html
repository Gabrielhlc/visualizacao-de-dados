<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ECharts World Map + Line Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        #container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        #map {
            flex: 2;
        }

        #linechart {
            flex: 1;
            min-height: 300px;
            border-top: 1px solid #ccc;
        }

        #controls {
            position: absolute;
            top: 10px;
            right: 200px;
            z-index: 10;
            background: rgba(255, 255, 255, 0.9);
            padding: 6px 12px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            font-family: Arial, sans-serif;
        }
    </style>
</head>

<body>
    <div id="controls">
        <label for="topic">Tópico:</label>
        <select id="topic">
            <option value="BAL">Balança comercial</option>
            <option value="IMP">Importações</option>
            <option value="EXP">Exportações</option>
        </select>

        <label for="metric">Métrica:</label>
        <select id="metric">
            <option value="us_value">Valor (dólar)</option>
            <option value="kg_weight">Peso (kg)</option>
        </select>
    </div>


    <div id="container">
        <div id="map"></div>
        <div id="linechart"></div>
    </div>

    <script>
        var mapChart = echarts.init(document.getElementById('map'));
        var lineChart = echarts.init(document.getElementById('linechart'));
        var allData = null;

        var yearSelected = 1997;

        function renderMap(topic, metric, year) {
            var yearData = [];

            var topicData = allData[topic][year] || [];
            topicData.forEach(item => {
                yearData.push({ name: item.name, value: item[metric] });
            });

            var textoFormatado = topic == "IMP" ? "Importações" : topic == "EXP" ? "Exportações" : "Balança comercial";

            var option = {
                title: { text: "Volume de " + textoFormatado + " do Brasil (Ano " + year + ")", subtext: "Valores em bilhões de US$" },
                tooltip: { trigger: 'item' },
                visualMap: {
                    min: 0,
                    max: Math.max(...yearData.map(d => d.value / 100000000)) || 1000,
                    text: ['Alto', 'Baixo'],
                    left: 'right',
                    top: 'middle',
                    calculable: true,
                    inRange: {
                        color: ['#313695', '#4575b4', '#74add1', '#abd9e9',
                            '#e0f3f8', '#ffffbf', '#fee090', '#fdae61',
                            '#f46d43', '#d73027', '#a50026']
                    }
                },
                series: [
                    {
                        name: metric,
                        type: 'map',
                        map: 'world',
                        roam: true,
                        emphasis: { label: { show: false } },
                        data: yearData
                    }
                ],
                graphic: [{
                    type: 'text',
                    left: '95%',
                    top: 'center',
                    style: {
                        text: 'Valores em bilhões de US$',
                        fill: '#000',
                        font: '14px sans-serif'
                    },
                    rotation: Math.PI / 2
                }]
            };
            mapChart.setOption(option, true);
        }

        function renderLine(metric) {
            var years = Object.keys(allData.BAL).sort();

            var series = ["BAL", "IMP", "EXP"].map(topic => {
                var values = years.map(y => {
                    var yearData = allData[topic][y] || [];
                    var total = yearData.reduce((sum, d) => sum + (d[metric] / 1000000000 || 0), 0);
                    return total;
                });
                return { name: topic, type: 'line', data: values, smooth: true };
            });

            var option = {
                title: { text: "Totais Globais por Ano", subtext: "Valores em Bilhões de US$", left: 'left', },

                tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
                legend: { top: 20, data: ["BAL", "IMP", "EXP"] },
                xAxis: { type: 'category', data: years },
                yAxis: { type: 'value' },
                series: series
            };



            lineChart.setOption(option, true);
        }

        $.get('./Lab7-GabrielCarvalho-world.json', function (worldJson) {
            echarts.registerMap('world', worldJson);

            $.get('./Lab7-GabrielCarvalho-BR-exportacoes_importacoes_2025.json', function (dados) {
                allData = dados;
                mapChart.hideLoading();
                lineChart.hideLoading();

                var initialTopic = $("#topic").val();
                var initialMetric = $("#metric").val();
                renderMap(initialTopic, initialMetric, yearSelected);
                renderLine(initialMetric);

                $("#topic, #metric").on("change", function () {
                    var topic = $("#topic").val();
                    var metric = $("#metric").val();
                    renderMap(topic, metric, "1997");
                    renderLine(metric);
                });

                lineChart.getZr().on('click', function (event) {
                    var pointInPixel = [event.offsetX, event.offsetY];
                    var xIndex = lineChart.convertFromPixel({ xAxisIndex: 0 }, pointInPixel[0]);
                    xIndex = Math.round(xIndex);
                    var years = Object.keys(allData.BAL).sort();
                    if (xIndex >= 0 && xIndex < years.length) {
                        var year = years[xIndex];
                        var topic = $("#topic").val();
                        var metric = $("#metric").val();
                        renderMap(topic, metric, year);
                    }
                });


            });
        });


        window.addEventListener("resize", function () {
            mapChart.resize();
            lineChart.resize();
        });
    </script>
</body>

</html>